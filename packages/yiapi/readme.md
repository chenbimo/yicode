# yiapiï¼ˆæ˜“æ¥å£ï¼‰

åŸºäº `fastify` è¿›è¡Œæ·±åº¦å°è£…çš„ `nodejs` æ¥å£å¼€å‘æ¡†æ¶

æœ¬ `yiapi` æ¡†æ¶ä½¿ç”¨ `GPL v3` åè®®ï¼Œ `å¼€æº`ã€`å…è´¹`ã€`å¯å•†ç”¨` ä½† `ä¸èƒ½äºŒæ¬¡å¼€å‘`

## ä½œè€…

| å±æ€§     | å€¼                                                    |
| -------- | ----------------------------------------------------- |
| å§“å     | é™ˆéšæ˜“                                                |
| æ€§åˆ«     | ç”·                                                    |
| å‡ºç”Ÿå¹´æœˆ | 1993 å¹´ 10 æœˆ                                         |
| èŒä¸š     | åŸºå±‚å°ç å†œ                                            |
| å°±ä¸šæ—¶é—´ | 2015 å¹´ 9 æœˆ                                          |
| æ€§æ ¼     | å–œæ¬¢å®‰é™ï¼Œå–œæ¬¢åˆ†äº«ï¼Œå–œæ¬¢é’»ç ”                          |
| çˆ±å¥½     | æ•²ä»£ç ï¼Œå†™å°è¯´ï¼Œçœ‹ç”µå½±ï¼Œç®—å‘½                          |
| å¾®ä¿¡     | c91374286                                             |
| æ‰£æ‰£     | 24323626                                              |
| é‚®ç®±     | bimostyle@qq.com                                      |
| çŸ¥ä¹     | [çŸ¥ä¹é™ˆéšæ˜“](https://www.zhihu.com/people/chensuiyi)  |
| æ˜é‡‘     | [æ˜é‡‘é™ˆéšæ˜“](https://juejin.im/user/1239904846873326) |
| ç äº‘     | [ç äº‘é™ˆéšæ˜“](https://gitee.com/banshiweichen)         |
| github   | [github é™ˆéšæ˜“](https://github.com/chenbimo)          |
| äº¤æµæ¢è®¨ | åˆ›å»ºäº†å…¨çƒé¡¶çº§ç¨‹åºå‘˜å¾®ä¿¡äº¤æµç¾¤ï¼ŒåŠ å…¥äº¤æµè¯·åŠ æˆ‘å¾®ä¿¡    |

## ç‰¹ç‚¹

-   åªéœ€ç®€å•é…ç½®ï¼Œç«‹å³ä¸Šæ‰‹å¼€å‘
-   æ•°æ®åº“è¡¨é€šè¿‡ä»£ç é…ç½®ï¼Œä¸€é”®åŒæ­¥
-   è‡ªåŠ¨ç”Ÿæˆæ¥å£æ–‡æ¡£
-   è‡ªå¸¦æƒé™ã€è§’è‰²ã€ç®¡ç†ã€æ—¥å¿—ç­‰åŸºç¡€åŠŸèƒ½
-   è‡ªå¸¦é‚®ä»¶å‘é€ã€æ–‡ä»¶ä¸Šä¼ ç­‰åŠŸèƒ½
-   è‡ªå¸¦æ—¥å¿—æ‰“å°å’Œæ—¥å¿—åˆ†å‰²åŠŸèƒ½

## æ•ˆæœ

ä½¿ç”¨ `yiapi` + `vue3` ç ”å‘çš„å…è´¹å¼€æºçš„ `æ˜“ç®¡ç†` åå°ç®¡ç†ç³»ç»Ÿ

![éšæ˜“ç§‘æŠ€](assets/3.png)

## åœºæ™¯

-   éå…³é”®å‹ã€å°å‹é¡¹ç›®ã€åšå®¢ç³»ç»Ÿã€è®ºå›ç³»ç»Ÿã€å®˜ç½‘ã€åå°ç®¡ç†ç­‰

## å®‰è£…

é»˜è®¤ä½¿ç”¨ `pnpm` ä½œä¸º `nodejs` åŒ…ç®¡ç†å·¥å…·

å¦‚æœªå®‰è£…ï¼Œè¯·ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…ï¼Œå¦åˆ™è¿è¡Œé¡¹ç›®ä¼šæœ‰æç¤ºä¿¡æ¯

```bash
npm install -g pnpm
```

å…¨å±€å®‰è£… `dlyicode` å®˜æ–¹èµ„æºä¸‹è½½å·¥å…·

```bash
npm install -g dlyicode
```

å…¨å±€å®‰è£…å¼€å‘ç¯å¢ƒä¸‹çš„è‡ªåŠ¨é‡å¯å·¥å…· `nodemon`

```bash
npm install -g nodemon
```

## ä¸‹è½½

å®‰è£…å®Œæ¯•åï¼Œä½¿ç”¨ `vscode` ç¼–è¾‘å™¨æ‰“å¼€ä¸€ä¸ªç©ºç›®å½•

ç„¶åæ‰“å¼€ç¼–è¾‘å™¨ä¸­çš„æ§åˆ¶å°ç•Œé¢ï¼Œåœ¨å‘½ä»¤è¡Œè¾“å…¥ `dlyicode` å¹¶å›è½¦ï¼ŒæŒ‰æç¤ºæ“ä½œå³å¯ã€‚

```bash
> dlyicode

â„¹ å¼€å‘è€…ï¼šéšæ˜“ç§‘æŠ€ï¼ˆhttps://yicode.techï¼‰
-----------------------------------------
? é€‰æ‹©ä¸‹è½½ç±»å‹ å®˜æ–¹èµ„æº
? é€‰æ‹©ä»å“ªé‡Œä¸‹è½½ æ·˜å®ä»“åº“ - npmmirror.com
? é€‰æ‹©è¦ä¸‹è½½çš„åŒ… yiapi-free æ˜“æ¥å£åŸºç¡€æ¨¡æ¿
? è¾“å…¥è¦ä¸‹è½½çš„ç‰ˆæœ¬ï¼ˆé»˜è®¤ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ï¼‰ latest
âœ” èµ„æºå·²ä¸‹è½½æˆåŠŸ!
```

ä¸‹è½½åçš„é¡¹ç›®ç»“æ„

```bash
â”œâ”€â”€â”€ğŸ“ addons/
â”‚   â””â”€â”€â”€ğŸ“ demo/
â”‚       â””â”€â”€â”€...
â”œâ”€â”€â”€ğŸ“ apis/
â”‚   â””â”€â”€â”€ğŸ“ news/
â”‚       â””â”€â”€â”€...
â”œâ”€â”€â”€ğŸ“ config/
â”‚   â””â”€â”€â”€ğŸ“„ appConfig.js
â”œâ”€â”€â”€ğŸ“ public/
â”‚   â”œâ”€â”€â”€ğŸ“ 2023/
â”‚   â”‚   â””â”€â”€â”€...
â”‚   â””â”€â”€â”€ğŸ“„ .gitkeep
â”œâ”€â”€â”€ğŸ“ tables/
â”œâ”€â”€â”€ğŸ“„ .gitignore
â”œâ”€â”€â”€ğŸ“„ .prettierrc
â”œâ”€â”€â”€ğŸ“„ nodemon.json
â”œâ”€â”€â”€ğŸ“„ package.json
â”œâ”€â”€â”€ğŸ“„ pm2.config.cjs
â”œâ”€â”€â”€ğŸ“„ README.md
â”œâ”€â”€â”€ğŸ“„ syncDatabase.js
â””â”€â”€â”€ğŸ“„ yiapi.js
```

## ç«‹å³ä½“éªŒ

1. åœ¨ `appConfig.js` æ–‡ä»¶ä¸­é…ç½®å¥½ `mysql`å’Œ `redis` å‚æ•°
2. æ‰§è¡Œ `pnpm run dev` è¿è¡Œæ¥å£
3. æµè§ˆå™¨è®¿é—® `http://127.0.0.1:3000`
4. æ¥å£æ–‡æ¡£ `http://127.0.0.1:3000/docs`

![éšæ˜“ç§‘æŠ€](assets/4.png)

## å¼€å‘æµç¨‹

1. åœ¨ `appConfig.js` æ–‡ä»¶ä¸­é…ç½®å¥½ `mysql`å’Œ `redis` å‚æ•°
2. åœ¨ `tables` ç›®å½•ä¸­å®šä¹‰å¥½è¡¨ç»“æ„
3. æ‰§è¡Œ `pnpm run sync` åŒæ­¥è¡¨ç»“æ„åˆ°æ•°æ®åº“
4. åœ¨ `apis` ç›®å½•ä¸­å†™å¥½æ¥å£
5. æ‰§è¡Œ `pnpm run dev` è¿è¡Œæ¥å£

å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ `yiapi` å¼€å‘æ¥å£åŠŸèƒ½ï¼Œæ ¸å¿ƒæ­¥éª¤åªæœ‰ `2` æ­¥

1. å®šä¹‰è¡¨ç»“æ„
2. å¼€å‘æ¥å£

è€Œä¸”è¡¨ç»“æ„å’Œæ¥å£å¼€å‘ä¹Ÿéå¸¸ç®€å•ã€‚

## è¡¨ç»“æ„å®šä¹‰

```json
// table_config.json
{
    "name": "æ•°æ®è¡¨é…ç½®",
    "fields": {
        "name": {
            "type": "string",
            "comment": "è¡¨åç§°",
            "length": 50,
            "default": ""
        },
        "code": {
            "type": "string",
            "comment": "è¡¨ç¼–ç ",
            "length": 50,
            "default": "",
            "options": ["unique"]
        },
        "value": {
            "type": "string",
            "comment": "è¡¨å­—æ®µ",
            "length": 10000,
            "default": ""
        },
        "sort": {
            "type": "bigint",
            "comment": "æ’åº",
            "default": 0
        },
        "describe": {
            "type": "string",
            "comment": "æè¿°",
            "length": 500,
            "default": ""
        }
    }
}
```

## æ¥å£å¼€å‘

```javascript
// å¯¼å…¥ yiapi å¯¹è±¡
import * as yiapi from '@yicode/yiapi';

// ç”¨äºè·å–æ¥å£ä¿¡æ¯çš„å‡½æ•°
const apiInfo = await yiapi.utils.fnApiInfo(import.meta.url);

// æ¥å£å‚æ•°éªŒè¯é…ç½®
export const apiSchema = {
    summary: `æŸ¥è¯¢èµ„è®¯åˆ—è¡¨`,
    tags: [apiInfo.parentDirName],
    description: `${apiInfo.apiPath}`,
    body: {
        type: 'object',
        title: 'æŸ¥è¯¢èµ„è®¯åˆ—è¡¨æ¥å£',
        properties: {
            category_id: yiapi.utils.fnSchema(yiapi.schemaField.pid, 'èµ„è®¯åˆ†ç±»'),
            page: yiapi.utils.fnSchema(yiapi.schemaField.page, 'ç¬¬å‡ é¡µ'),
            limit: yiapi.utils.fnSchema(yiapi.schemaField.limit, 'æ¯é¡µæ•°é‡'),
            keywords: yiapi.utils.fnSchema(yiapi.schemaField.keywords, 'æœç´¢å…³é”®å­—')
        },
        required: ['category_id']
    }
};

export default async function (fastify, opts) {
    // åˆ›å»ºä¸€ä¸ª post åè®®çš„æ¥å£ï¼Œæ¥å£åœ°å€ä¸º /news/select
    fastify.post(`/${apiInfo.pureFileName}`, {
        schema: apiSchema,
        config: {},
        handler: async function (req, res) {
            const trx = await fastify.mysql.transaction();
            try {
                // æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨
                let newsCategoryModel = trx.table('news').modify(function (db) {
                    if (req.body.category_id > 0) {
                        db.where('category_id', req.body.category_id);
                    }
                });

                // è®°å½•æ€»æ•°
                let { total } = await newsCategoryModel
                    .clone() //
                    .count('id', { as: 'total' })
                    .first();

                // è®°å½•åˆ—è¡¨
                let rows = await newsCategoryModel
                    .clone() //
                    .orderBy('created_at', 'desc')
                    .offset(yiapi.utils.fnPageOffset(req.body.page, req.body.limit))
                    .limit(req.body.limit)
                    .select();

                await trx.commit();

                // æŸ¥è¯¢æˆåŠŸï¼Œè¿”å›æ•°æ®
                return {
                    ...yiapi.appConfig.httpCode.SELECT_SUCCESS,
                    data: {
                        total: total,
                        rows: rows,
                        page: req.body.page,
                        limit: req.body.limit
                    }
                };
            } catch (err) {
                // æŸ¥è¯¢å¤±è´¥ï¼Œå›æ»šæ•°æ®
                fastify.log.error(err);
                await trx.rollback();
                return yiapi.appConfig.httpCode.SELECT_FAIL;
            }
        }
    });
}
```

## éƒ¨ç½²

`yiapi` ä½¿ç”¨ `pm2` è¿›è¡Œæ­£å¼ç¯å¢ƒçš„éƒ¨ç½²å’Œç®¡ç†

å®‰è£… `pm2`

```bash
npm install -g pm2
```

æ­£å¼ç¯å¢ƒè¿è¡Œ

```bash
npm run build
```

`åå‘ä»£ç†`ã€`https`ã€`é™æ€æ–‡ä»¶æ‰˜ç®¡` ç­‰

æ¨èä½¿ç”¨ `caddy` ï¼Œç®€å•ã€æ–¹ä¾¿ã€é«˜æ•ˆï¼Œè‡ªåŠ¨é…ç½®åŸŸåçš„ `https`

## æ€»ç»“

ä½¿ç”¨ `yiapi` å¼€å‘åç«¯æ¥å£å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œå…¨éƒ¨å›´ç»•ç€ `åˆ›å»ºè¡¨ç»“æ„` å’Œ `å¼€å‘ä¸šåŠ¡æ¥å£` æ¥è¿›è¡Œã€‚

çœŸæ­£åšåˆ°äº†ç®€å•æ˜“ç”¨ï¼Œæ–¹ä¾¿å¿«æ·ï¼

`yiapi` çš„è¯¦ç»†ä½¿ç”¨æ–‡æ¡£ï¼Œä¹Ÿå°†å›´ç»•ç€è¿™ `2` ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œè¿›è¡Œå±•å¼€ï¼Œè®©æˆ‘ä»¬çš„æ¥å£å¼€å‘ï¼Œå……æ»¡æ¬¢å£°ç¬‘è¯­ã€‚

è¯¦ç»†æ–‡æ¡£åœ°å€ [æ˜“æ–‡æ¡£](https://doc.yicode.tech)
