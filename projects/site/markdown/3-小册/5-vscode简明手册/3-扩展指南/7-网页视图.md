# ç½‘é¡µè§†å›¾ API

Webview API å…è®¸æ‰©å±•åœ¨ Visual Studio Code ä¸­åˆ›å»ºå®Œå…¨å¯è‡ªå®šä¹‰çš„è§†å›¾ã€‚ ä¾‹å¦‚ï¼Œå†…ç½®çš„ Markdown æ‰©å±•ä½¿ç”¨ webview æ¥æ¸²æŸ“ Markdown é¢„è§ˆã€‚ Webview è¿˜å¯ä»¥ç”¨äºæ„å»ºè¶…å‡º VS Code åŸç”Ÿ API æ”¯æŒèŒƒå›´çš„å¤æ‚ç”¨æˆ·ç•Œé¢ã€‚

å°† webview è§†ä¸º VS Code ä¸­ç”±æ‚¨çš„æ‰©å±•æ§åˆ¶çš„"iframe"ã€‚ Webview å¯ä»¥åœ¨æ­¤æ¡†æ¶ä¸­å‘ˆç°å‡ ä¹ä»»ä½• HTML å†…å®¹ï¼Œå¹¶ä¸”å®ƒä½¿ç”¨æ¶ˆæ¯ä¼ é€’ä¸æ‰©å±•è¿›è¡Œé€šä¿¡ã€‚ è¿™ç§è‡ªç”±ä½¿å¾—ç½‘ç»œè§†å›¾å˜å¾—å¼‚å¸¸å¼ºå¤§ï¼Œå¹¶å¼€è¾Ÿäº†ä¸€ç³»åˆ—å…¨æ–°çš„æ‰©å±•å¯èƒ½æ€§ã€‚

Webview åœ¨å¤šä¸ª VS Code API ä¸­ä½¿ç”¨ï¼š

-   ä½¿ç”¨"createWebviewPanel"åˆ›å»º Webview é¢æ¿ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒWebview é¢æ¿åœ¨ VS Code ä¸­æ˜¾ç¤ºä¸ºä¸åŒçš„ç¼–è¾‘å™¨ã€‚ è¿™ä½¿å¾—å®ƒä»¬å¯¹äºæ˜¾ç¤ºè‡ªå®šä¹‰ UI å’Œè‡ªå®šä¹‰å¯è§†åŒ–éå¸¸æœ‰ç”¨ã€‚
-   ä½œä¸º[è‡ªå®šä¹‰ç¼–è¾‘å™¨](https://code.visualstudio.com/api/extension-guides/custom-editors)çš„è§†å›¾ã€‚ è‡ªå®šä¹‰ç¼–è¾‘å™¨å…è®¸æ‰©å±•æä¾›è‡ªå®šä¹‰ UIï¼Œç”¨äºç¼–è¾‘å·¥ä½œåŒºä¸­çš„ä»»ä½•æ–‡ä»¶ã€‚ è‡ªå®šä¹‰ç¼–è¾‘å™¨ API è¿˜å…è®¸æ‚¨çš„æ‰©å±•æŒ‚é’©ç¼–è¾‘å™¨äº‹ä»¶ï¼ˆä¾‹å¦‚æ’¤æ¶ˆå’Œé‡åšï¼‰ä»¥åŠæ–‡ä»¶äº‹ä»¶ï¼ˆä¾‹å¦‚ä¿å­˜ï¼‰ã€‚
-   åœ¨ä¾§è¾¹æ æˆ–é¢æ¿åŒºåŸŸä¸­å‘ˆç°çš„ [Webview è§†å›¾](https://code.visualstudio.com/api/references/vscode-api#WebviewView) ä¸­ã€‚ æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [webview è§†å›¾ç¤ºä¾‹æ‰©å±•](https://github.com/microsoft/vscode-extension-samples/tree/main/webview-view-sample)ã€‚

æœ¬é¡µé¢é‡ç‚¹ä»‹ç»åŸºæœ¬çš„ Web è§†å›¾é¢æ¿ APIï¼Œå°½ç®¡æ­¤å¤„ä»‹ç»çš„å‡ ä¹æ‰€æœ‰å†…å®¹ä¹Ÿé€‚ç”¨äºè‡ªå®šä¹‰ç¼–è¾‘å™¨å’Œ Web è§†å›¾è§†å›¾ä¸­ä½¿ç”¨çš„ Web è§†å›¾ã€‚ å³ä½¿æ‚¨å¯¹è¿™äº› API æ›´æ„Ÿå…´è¶£ï¼Œæˆ‘ä»¬ä¹Ÿå»ºè®®æ‚¨å…ˆé˜…è¯»æ­¤é¡µé¢ä»¥ç†Ÿæ‚‰ webview åŸºç¡€çŸ¥è¯†ã€‚

## é“¾æ¥

-   [Webview ç¤ºä¾‹](https://github.com/microsoft/vscode-extension-samples/blob/main/webview-sample/README.md)
-   [è‡ªå®šä¹‰ç¼–è¾‘å™¨æ–‡æ¡£](https://code.visualstudio.com/api/extension-guides/custom-editors)
-   [Webview è§†å›¾ç¤ºä¾‹](https://github.com/microsoft/vscode-extension-samples/tree/main/webview-view-sample)

### VS Code API ç”¨æ³•

-   [`window.createWebviewPanel`](https://code.visualstudio.com/api/references/vscode-api#window.createWebviewPanel)
-   [`window.registerWebviewPanelSerializer`](https://code.visualstudio.com/api/references/vscode-api#window.registerWebviewPanelSerializer)

## æˆ‘åº”è¯¥ä½¿ç”¨ç½‘ç»œè§†å›¾å—ï¼Ÿ

Webview éå¸¸ä»¤äººæƒŠå¥‡ï¼Œä½†ä¹Ÿåº”è¯¥è°¨æ…ä½¿ç”¨å®ƒä»¬ï¼Œå¹¶ä¸”ä»…åœ¨ VS Code çš„æœ¬æœº API ä¸è¶³æ—¶æ‰ä½¿ç”¨ã€‚ Webview å ç”¨å¤§é‡èµ„æºï¼Œå¹¶ä¸”åœ¨ä¸æ™®é€šæ‰©å±•ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚ è®¾è®¡ä¸ä½³çš„ WebView ä¹Ÿå¾ˆå®¹æ˜“è®©äººæ„Ÿè§‰ä¸ VS Code æ ¼æ ¼ä¸å…¥ã€‚

åœ¨ä½¿ç”¨ webview ä¹‹å‰ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹äº‹é¡¹ï¼š

-   æ­¤åŠŸèƒ½çœŸçš„éœ€è¦å­˜åœ¨äº VS Code ä¸­å—ï¼Ÿ ä½œä¸ºå•ç‹¬çš„åº”ç”¨ç¨‹åºæˆ–ç½‘ç«™ä¼šæ›´å¥½å—ï¼Ÿ

-   ç½‘ç»œè§†å›¾æ˜¯å®ç°æ‚¨çš„åŠŸèƒ½çš„å”¯ä¸€æ–¹æ³•å—ï¼Ÿ æ‚¨å¯ä»¥æ”¹ç”¨å¸¸è§„ VS Code API å—ï¼Ÿ

-   æ‚¨çš„ç½‘é¡µè§†å›¾ä¼šå¢åŠ è¶³å¤Ÿçš„ç”¨æˆ·ä»·å€¼æ¥è¯æ˜å…¶é«˜èµ„æºæˆæœ¬çš„åˆç†æ€§å—ï¼Ÿ

è¯·è®°ä½ï¼šä»…ä»…å› ä¸ºæ‚¨å¯ä»¥ä½¿ç”¨ç½‘ç»œè§†å›¾æ‰§è¡ŒæŸäº›æ“ä½œï¼Œå¹¶ä¸æ„å‘³ç€æ‚¨åº”è¯¥è¿™æ ·åšã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨ç¡®ä¿¡éœ€è¦ä½¿ç”¨ webviewï¼Œé‚£ä¹ˆæœ¬æ–‡æ¡£å¯ä»¥ä¸ºæ‚¨æä¾›å¸®åŠ©ã€‚ è®©æˆ‘ä»¬å¼€å§‹å§ã€‚

## Webview API åŸºç¡€çŸ¥è¯†

ä¸ºäº†è§£é‡Š webview APIï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªåä¸º **Cat Coding** çš„ç®€å•æ‰©å±•ã€‚ æ­¤æ‰©å±•å°†ä½¿ç”¨ webview æ˜¾ç¤ºä¸€åªçŒ«æ­£åœ¨ç¼–å†™ä¸€äº›ä»£ç çš„ gifï¼ˆå¤§æ¦‚æ˜¯åœ¨ VS Code ä¸­ï¼‰ã€‚ å½“æˆ‘ä»¬ä½¿ç”¨ API æ—¶ï¼Œæˆ‘ä»¬å°†ç»§ç»­å‘æ‰©å±•æ·»åŠ åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºè·Ÿè¸ªæˆ‘ä»¬çš„çŒ«ç¼–å†™äº†å¤šå°‘è¡Œæºä»£ç ï¼Œä»¥åŠåœ¨çŒ«å¼•å…¥é”™è¯¯æ—¶é€šçŸ¥ç”¨æˆ·çš„é€šçŸ¥ã€‚

è¿™æ˜¯ **Cat Coding** æ‰©å±•çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„ `package.json`ã€‚ æ‚¨å¯ä»¥åœ¨[æ­¤å¤„](https://github.com/microsoft/vscode-extension-samples/blob/main/webview-sample/README.md)æ‰¾åˆ°ç¤ºä¾‹åº”ç”¨ç¨‹åºçš„å®Œæ•´ä»£ç ã€‚ æˆ‘ä»¬çš„æ‰©å±•çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬[æä¾›ä¸€ä¸ªå‘½ä»¤](https://code.visualstudio.com/api/references/contribution-points#contributes.commands)ç§°ä¸º"catCoding.start"ã€‚ å½“ç”¨æˆ·è°ƒç”¨æ­¤å‘½ä»¤æ—¶ï¼Œæˆ‘ä»¬å°†æ˜¾ç¤ºä¸€ä¸ªç®€å•çš„ Web è§†å›¾ï¼Œå…¶ä¸­åŒ…å«æˆ‘ä»¬çš„çŒ«ã€‚ ç”¨æˆ·å°†èƒ½å¤Ÿä» **å‘½ä»¤é¢æ¿** è°ƒç”¨æ­¤å‘½ä»¤ä½œä¸º **Cat ç¼–ç ï¼šå¼€å§‹æ–°çš„ cat ç¼–ç ä¼šè¯**ï¼Œç”šè‡³å¦‚æœä»–ä»¬æ„¿æ„çš„è¯ï¼Œç”šè‡³å¯ä»¥ä¸ºå…¶åˆ›å»ºä¸€ä¸ªé”®ç»‘å®šã€‚

```json
{
    "name": "cat-coding",
    "description": "Cat Coding",
    "version": "0.0.1",
    "publisher": "bierner",
    "engines": {
        "vscode": "^1.74.0"
    },
    "activationEvents": [],
    "main": "./out/src/extension",
    "contributes": {
        "commands": [
            {
                "command": "catCoding.start",
                "title": "Start new cat coding session",
                "category": "Cat Coding"
            }
        ]
    },
    "scripts": {
        "vscode:prepublish": "tsc -p ./",
        "compile": "tsc -watch -p ./",
        "postinstall": "node ./node_modules/vscode/bin/install"
    },
    "dependencies": {
        "vscode": "*"
    },
    "devDependencies": {
        "@types/node": "^9.4.6",
        "typescript": "^2.8.3"
    }
}
```

> **æ³¨æ„**ï¼šå¦‚æœæ‚¨çš„æ‰©å±•é¢å‘ 1.74 ä¹‹å‰çš„ VS Code ç‰ˆæœ¬ï¼Œåˆ™å¿…é¡»åœ¨ `activationEvents` ä¸­æ˜¾å¼åˆ—å‡º `onCommand:catCoding.start`ã€‚

ç°åœ¨è®©æˆ‘ä»¬å®ç°"catCoding.start"å‘½ä»¤ã€‚ åœ¨æˆ‘ä»¬çš„æ‰©å±•çš„ä¸»æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ³¨å†Œ `catCoding.start` å‘½ä»¤å¹¶ä½¿ç”¨å®ƒæ¥æ˜¾ç¤ºåŸºæœ¬çš„ Web è§†å›¾ï¼š

```ts
import * as vscode from 'vscode';

export function activate(context: vscode.ExtensionContext) {
    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.start', () => {
            // Create and show a new webview
            const panel = vscode.window.createWebviewPanel(
                'catCoding', // Identifies the type of the webview. Used internally
                'Cat Coding', // Title of the panel displayed to the user
                vscode.ViewColumn.One, // Editor column to show the new webview panel in.
                {} // Webview options. More on these later.
            );
        })
    );
}
```

`vscode.window.createWebviewPanel` å‡½æ•°åœ¨ç¼–è¾‘å™¨ä¸­åˆ›å»ºå¹¶æ˜¾ç¤ºä¸€ä¸ª webviewã€‚ å¦‚æœæ‚¨å°è¯•åœ¨å½“å‰çŠ¶æ€ä¸‹è¿è¡Œ"catCoding.start"å‘½ä»¤ï¼Œæ‚¨ä¼šçœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š

![ä¸€ä¸ªç©ºçš„ç½‘é¡µè§†å›¾](https://static.yicode.tech/images/vscode-docs/webview/basics-no_content.png)

æˆ‘ä»¬çš„å‘½ä»¤æ‰“å¼€ä¸€ä¸ªæ–°çš„ webview é¢æ¿ï¼Œå…¶æ ‡é¢˜æ­£ç¡®ï¼Œä½†æ²¡æœ‰å†…å®¹ï¼ è¦å°†æˆ‘ä»¬çš„çŒ«æ·»åŠ åˆ°æ–°é¢æ¿ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨"webview.html"è®¾ç½® webview çš„ HTML å†…å®¹ï¼š

```ts
import * as vscode from 'vscode';

export function activate(context: vscode.ExtensionContext) {
    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.start', () => {
            // Create and show panel
            const panel = vscode.window.createWebviewPanel('catCoding', 'Cat Coding', vscode.ViewColumn.One, {});

            // And set its HTML content
            panel.webview.html = getWebviewContent();
        })
    );
}

function getWebviewContent() {
    return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Coding</title>
</head>
<body>
    <img src="https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif" width="300" />
</body>
</html>`;
}
```

å¦‚æœå†æ¬¡è¿è¡Œè¯¥å‘½ä»¤ï¼Œç°åœ¨ Web è§†å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![å¸¦æœ‰ä¸€äº› HTML çš„ webview](https://static.yicode.tech/images/vscode-docs/webview/basics-html.png)

è¿›æ­¥ï¼

`webview.html` åº”è¯¥å§‹ç»ˆæ˜¯ä¸€ä¸ªå®Œæ•´çš„ HTML æ–‡æ¡£ã€‚ HTML ç‰‡æ®µæˆ–æ ¼å¼é”™è¯¯çš„ HTML å¯èƒ½ä¼šå¯¼è‡´æ„å¤–è¡Œä¸ºã€‚

### æ›´æ–°ç½‘é¡µè§†å›¾å†…å®¹

`webview.html` è¿˜å¯ä»¥åœ¨åˆ›å»º webview åæ›´æ–°å®ƒçš„å†…å®¹ã€‚ è®©æˆ‘ä»¬é€šè¿‡å¼•å…¥çŒ«çš„è½®æ¢æ¥ä½¿ **Cat Coding** æ›´åŠ åŠ¨æ€ï¼š

```ts
import * as vscode from 'vscode';

const cats = {
    'Coding Cat': 'https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif',
    'Compiling Cat': 'https://media.giphy.com/media/mlvseq9yvZhba/giphy.gif'
};

export function activate(context: vscode.ExtensionContext) {
    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.start', () => {
            const panel = vscode.window.createWebviewPanel('catCoding', 'Cat Coding', vscode.ViewColumn.One, {});

            let iteration = 0;
            const updateWebview = () => {
                const cat = iteration++ % 2 ? 'Compiling Cat' : 'Coding Cat';
                panel.title = cat;
                panel.webview.html = getWebviewContent(cat);
            };

            // Set initial content
            updateWebview();

            // And schedule updates to the content every second
            setInterval(updateWebview, 1000);
        })
    );
}

function getWebviewContent(cat: keyof typeof cats) {
    return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Coding</title>
</head>
<body>
    <img src="${cats[cat]}" width="300" />
</body>
</html>`;
}
```

![Updating the webview content](https://static.yicode.tech/images/vscode-docs/webview/basics-update.gif)

è®¾ç½® webview.html ä¼šæ›¿æ¢æ•´ä¸ª webview å†…å®¹ï¼Œç±»ä¼¼äºé‡æ–°åŠ è½½ iframeã€‚ ä¸€æ—¦å¼€å§‹åœ¨ webview ä¸­ä½¿ç”¨è„šæœ¬ï¼Œè®°ä½è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºè¿™æ„å‘³ç€è®¾ç½®"webview.html"ä¹Ÿä¼šé‡ç½®è„šæœ¬çš„çŠ¶æ€ã€‚

ä¸Šé¢çš„ç¤ºä¾‹è¿˜ä½¿ç”¨"webview.title"æ¥æ›´æ”¹ç¼–è¾‘å™¨ä¸­æ˜¾ç¤ºçš„æ–‡æ¡£æ ‡é¢˜ã€‚ è®¾ç½®æ ‡é¢˜ä¸ä¼šå¯¼è‡´ webview é‡æ–°åŠ è½½ã€‚

### ç”Ÿå‘½å‘¨æœŸ

Webview é¢æ¿ç”±åˆ›å»ºå®ƒä»¬çš„æ‰©å±•æ‹¥æœ‰ã€‚ æ‰©å±•ç¨‹åºå¿…é¡»ä¿ç•™ä» `createWebviewPanel` è¿”å›çš„ webviewã€‚ å¦‚æœæ‚¨çš„æ‰©å±•ç¨‹åºä¸¢å¤±äº†æ­¤å¼•ç”¨ï¼Œåˆ™å®ƒæ— æ³•å†æ¬¡é‡æ–°è·å¾—å¯¹è¯¥ Web è§†å›¾çš„è®¿é—®æƒé™ï¼Œå³ä½¿è¯¥ Web è§†å›¾å°†ç»§ç»­æ˜¾ç¤ºåœ¨ VS Code ä¸­ã€‚

ä¸æ–‡æœ¬ç¼–è¾‘å™¨ä¸€æ ·ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥éšæ—¶å…³é—­ Web è§†å›¾é¢æ¿ã€‚ å½“ç”¨æˆ·å…³é—­ webview é¢æ¿æ—¶ï¼Œwebview æœ¬èº«å°±ä¼šè¢«é”€æ¯ã€‚ å°è¯•ä½¿ç”¨å·²é”€æ¯çš„ webview ä¼šå¼•å‘å¼‚å¸¸ã€‚ è¿™æ„å‘³ç€ä¸Šé¢ä½¿ç”¨"setInterval"çš„ç¤ºä¾‹å®é™…ä¸Šæœ‰ä¸€ä¸ªé‡è¦çš„é”™è¯¯ï¼šå¦‚æœç”¨æˆ·å…³é—­é¢æ¿ï¼Œ"setInterval"å°†ç»§ç»­è§¦å‘ï¼Œå®ƒå°†å°è¯•æ›´æ–°"panel.webview.html"ï¼Œè¿™å½“ç„¶ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ ä¾‹å¤–ã€‚ çŒ«è®¨åŒä¾‹å¤–ã€‚ è®©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ï¼

å½“ webview è¢«é”€æ¯æ—¶ï¼Œä¼šè§¦å‘ `onDidDispose` äº‹ä»¶ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ­¤äº‹ä»¶å–æ¶ˆè¿›ä¸€æ­¥æ›´æ–°å¹¶æ¸…ç† webview çš„èµ„æºï¼š

```ts
import * as vscode from 'vscode';

const cats = {
    'Coding Cat': 'https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif',
    'Compiling Cat': 'https://media.giphy.com/media/mlvseq9yvZhba/giphy.gif'
};

export function activate(context: vscode.ExtensionContext) {
    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.start', () => {
            const panel = vscode.window.createWebviewPanel('catCoding', 'Cat Coding', vscode.ViewColumn.One, {});

            let iteration = 0;
            const updateWebview = () => {
                const cat = iteration++ % 2 ? 'Compiling Cat' : 'Coding Cat';
                panel.title = cat;
                panel.webview.html = getWebviewContent(cat);
            };

            updateWebview();
            const interval = setInterval(updateWebview, 1000);

            panel.onDidDispose(
                () => {
                    // When the panel is closed, cancel any future updates to the webview content
                    clearInterval(interval);
                },
                null,
                context.subscriptions
            );
        })
    );
}
```

æ‰©å±•ç¨‹åºè¿˜å¯ä»¥é€šè¿‡è°ƒç”¨"dispose()"ä»¥ç¼–ç¨‹æ–¹å¼å…³é—­ Web è§†å›¾ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å°†çŒ«çš„å·¥ä½œæ—¥é™åˆ¶ä¸ºäº”ç§’ï¼š

```ts
export function activate(context: vscode.ExtensionContext) {
    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.start', () => {
            const panel = vscode.window.createWebviewPanel('catCoding', 'Cat Coding', vscode.ViewColumn.One, {});

            panel.webview.html = getWebviewContent(cats['Coding Cat']);

            // After 5sec, programmatically close the webview panel
            const timeout = setTimeout(() => panel.dispose(), 5000);

            panel.onDidDispose(
                () => {
                    // Handle user closing panel before the 5sec have passed
                    clearTimeout(timeout);
                },
                null,
                context.subscriptions
            );
        })
    );
}
```

### å¯è§æ€§å’Œç§»åŠ¨

å½“ Web è§†å›¾é¢æ¿ç§»è‡³èƒŒæ™¯é€‰é¡¹å¡æ—¶ï¼Œå®ƒä¼šè¢«éšè—ã€‚ ä½†å®ƒå¹¶æ²¡æœ‰è¢«ç ´åã€‚ å½“é¢æ¿å†æ¬¡è¿›å…¥å‰å°æ—¶ï¼ŒVS Code ä¼šè‡ªåŠ¨ä» `webview.html` æ¢å¤ webview çš„å†…å®¹ï¼š

![å½“webviewå†æ¬¡å¯è§æ—¶ï¼Œwebviewå†…å®¹ä¼šè‡ªåŠ¨æ¢å¤](https://static.yicode.tech/images/vscode-docs/webview/basics-restore.gif)

`.visible` å±æ€§å‘Šè¯‰æ‚¨ webview é¢æ¿å½“å‰æ˜¯å¦å¯è§ã€‚

æ‰©å±•å¯ä»¥é€šè¿‡è°ƒç”¨"reveal()"ä»¥ç¼–ç¨‹æ–¹å¼å°† webview é¢æ¿å¸¦åˆ°å‰å°ã€‚ æ­¤æ–¹æ³•é‡‡ç”¨å¯é€‰çš„ç›®æ ‡è§†å›¾åˆ—æ¥æ˜¾ç¤ºé¢æ¿ã€‚Web è§†å›¾é¢æ¿ä¸€æ¬¡åªèƒ½æ˜¾ç¤ºåœ¨ä¸€ä¸ªç¼–è¾‘å™¨åˆ—ä¸­ã€‚ è°ƒç”¨"reveal()"æˆ–å°† Web è§†å›¾é¢æ¿æ‹–åŠ¨åˆ°æ–°çš„ç¼–è¾‘å™¨åˆ—ä¼šå°† Web è§†å›¾ç§»åŠ¨åˆ°è¯¥æ–°åˆ—ä¸­ã€‚

![å½“æ‚¨åœ¨é€‰é¡¹å¡ä¹‹é—´æ‹–åŠ¨ Webview æ—¶ï¼ŒWebview ä¼šè¢«ç§»åŠ¨](https://static.yicode.tech/images/vscode-docs/webview/basics-drag.gif)

è®©æˆ‘ä»¬æ›´æ–°æˆ‘ä»¬çš„æ‰©å±•ï¼Œä»¥ä¸€æ¬¡åªå…è®¸ä¸€ä¸ª webview å­˜åœ¨ã€‚ å¦‚æœé¢æ¿ä½äºåå°ï¼Œåˆ™"catCoding.start"å‘½ä»¤ä¼šå°†å…¶å¸¦åˆ°å‰å°ï¼š

```ts
export function activate(context: vscode.ExtensionContext) {
    // Track currently webview panel
    let currentPanel: vscode.WebviewPanel | undefined = undefined;

    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.start', () => {
            const columnToShowIn = vscode.window.activeTextEditor ? vscode.window.activeTextEditor.viewColumn : undefined;

            if (currentPanel) {
                // If we already have a panel, show it in the target column
                currentPanel.reveal(columnToShowIn);
            } else {
                // Otherwise, create a new panel
                currentPanel = vscode.window.createWebviewPanel('catCoding', 'Cat Coding', columnToShowIn, {});
                currentPanel.webview.html = getWebviewContent('Coding Cat');

                // Reset when the current panel is closed
                currentPanel.onDidDispose(
                    () => {
                        currentPanel = undefined;
                    },
                    null,
                    context.subscriptions
                );
            }
        })
    );
}
```

è¿™æ˜¯æ­£åœ¨è¿è¡Œçš„æ–°æ‰©å±•ï¼š

![ä½¿ç”¨å•ä¸ªé¢æ¿å¹¶æ˜¾ç¤º](https://static.yicode.tech/images/vscode-docs/webview/basics-single_panel.gif)

æ¯å½“ Web è§†å›¾çš„å¯è§æ€§å‘ç”Ÿå˜åŒ–ï¼Œæˆ–è€…å½“ Web è§†å›¾ç§»åŠ¨åˆ°æ–°åˆ—æ—¶ï¼Œéƒ½ä¼šè§¦å‘"onDidChangeViewState"äº‹ä»¶ã€‚ æˆ‘ä»¬çš„æ‰©å±•å¯ä»¥ä½¿ç”¨æ­¤äº‹ä»¶æ ¹æ® web è§†å›¾æ˜¾ç¤ºçš„åˆ—æ¥æ›´æ”¹çŒ«ï¼š

```ts
const cats = {
    'Coding Cat': 'https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif',
    'Compiling Cat': 'https://media.giphy.com/media/mlvseq9yvZhba/giphy.gif',
    'Testing Cat': 'https://media.giphy.com/media/3oriO0OEd9QIDdllqo/giphy.gif'
};

export function activate(context: vscode.ExtensionContext) {
    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.start', () => {
            const panel = vscode.window.createWebviewPanel('catCoding', 'Cat Coding', vscode.ViewColumn.One, {});
            panel.webview.html = getWebviewContent('Coding Cat');

            // Update contents based on view state changes
            panel.onDidChangeViewState(
                (e) => {
                    const panel = e.webviewPanel;
                    switch (panel.viewColumn) {
                        case vscode.ViewColumn.One:
                            updateWebviewForCat(panel, 'Coding Cat');
                            return;

                        case vscode.ViewColumn.Two:
                            updateWebviewForCat(panel, 'Compiling Cat');
                            return;

                        case vscode.ViewColumn.Three:
                            updateWebviewForCat(panel, 'Testing Cat');
                            return;
                    }
                },
                null,
                context.subscriptions
            );
        })
    );
}

function updateWebviewForCat(panel: vscode.WebviewPanel, catName: keyof typeof cats) {
    panel.title = catName;
    panel.webview.html = getWebviewContent(catName);
}
```

![Responding to onDidChangeViewState events](https://static.yicode.tech/images/vscode-docs/webview/basics-ondidchangeviewstate.gif)

### æ£€æŸ¥å’Œè°ƒè¯• webview

**å¼€å‘äººå‘˜ï¼šåˆ‡æ¢å¼€å‘äººå‘˜å·¥å…·**å‘½ä»¤ä¼šæ‰“å¼€ä¸€ä¸ª [å¼€å‘äººå‘˜å·¥å…·](https://developer.chrome.com/docs/devtools/) çª—å£ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¯¥çª—å£è¿›è¡Œè°ƒè¯•å’Œæ£€æŸ¥æ‚¨çš„ Web è§†å›¾ã€‚

![å¼€å‘è€…å·¥å…·](https://static.yicode.tech/images/vscode-docs/webview/developer-overview.png)

è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨ä½¿ç”¨çš„ VS Code ç‰ˆæœ¬æ—©äº 1.56ï¼Œæˆ–è€…æ‚¨å°è¯•è°ƒè¯•è®¾ç½®äº†"enableFindWidget"çš„ Webviewï¼Œåˆ™å¿…é¡»ä½¿ç”¨ **å¼€å‘äººå‘˜ï¼šæ‰“å¼€ Webview å¼€å‘äººå‘˜å·¥å…·** å‘½ä»¤ã€‚ æ­¤å‘½ä»¤ä¸ºæ¯ä¸ª Web è§†å›¾æ‰“å¼€ä¸“ç”¨çš„å¼€å‘äººå‘˜å·¥å…·é¡µé¢ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç”±æ‰€æœ‰ Web è§†å›¾å’Œç¼–è¾‘å™¨æœ¬èº«å…±äº«çš„å¼€å‘äººå‘˜å·¥å…·é¡µé¢ã€‚

åœ¨å¼€å‘äººå‘˜å·¥å…·ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä½äºå¼€å‘äººå‘˜å·¥å…·çª—å£å·¦ä¸Šè§’çš„æ£€æŸ¥å·¥å…·å¼€å§‹æ£€æŸ¥ Web è§†å›¾çš„å†…å®¹ï¼š

![ä½¿ç”¨å¼€å‘è€…å·¥å…·æ£€æŸ¥WebView](https://static.yicode.tech/images/vscode-docs/webview/developer-inspect.png)

æ‚¨è¿˜å¯ä»¥åœ¨å¼€å‘äººå‘˜å·¥å…·æ§åˆ¶å°ä¸­æŸ¥çœ‹ Web è§†å›¾ä¸­çš„æ‰€æœ‰é”™è¯¯å’Œæ—¥å¿—ï¼š

![å¼€å‘è€…å·¥å…·æ§åˆ¶å°](https://static.yicode.tech/images/vscode-docs/webview/developer-console.png)

è¦åœ¨ Web è§†å›¾ä¸Šä¸‹æ–‡ä¸­è®¡ç®—è¡¨è¾¾å¼ï¼Œè¯·ç¡®ä¿ä»å¼€å‘äººå‘˜å·¥å…·æ§åˆ¶å°é¢æ¿å·¦ä¸Šè§’çš„ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹© **æ´»åŠ¨æ¡†æ¶** ç¯å¢ƒï¼š

![é€‰æ‹©æ´»åŠ¨æ¡†æ¶](https://static.yicode.tech/images/vscode-docs/webview/developer-active-frame.png)

**æ´»åŠ¨æ¡†æ¶**ç¯å¢ƒæ˜¯æ‰§è¡Œ webview è„šæœ¬æœ¬èº«çš„åœ°æ–¹ã€‚

æ­¤å¤–ï¼Œ**å¼€å‘äººå‘˜ï¼šé‡æ–°åŠ è½½ Webview** å‘½ä»¤ä¼šé‡æ–°åŠ è½½æ‰€æœ‰æ´»åŠ¨çš„ Web è§†å›¾ã€‚ å¦‚æœæ‚¨éœ€è¦é‡ç½® Web è§†å›¾çš„çŠ¶æ€ï¼Œæˆ–è€…ç£ç›˜ä¸Šçš„æŸäº› Web è§†å›¾å†…å®¹å·²æ›´æ”¹å¹¶ä¸”æ‚¨å¸Œæœ›åŠ è½½æ–°å†…å®¹ï¼Œè¿™ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚

## åŠ è½½æœ¬åœ°å†…å®¹

Webview åœ¨æ— æ³•ç›´æ¥è®¿é—®æœ¬åœ°èµ„æºçš„éš”ç¦»ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚ è¿™æ ·åšæ˜¯å‡ºäºå®‰å…¨åŸå› ã€‚ è¿™æ„å‘³ç€ï¼Œä¸ºäº†ä»æ‚¨çš„æ‰©å±•åŠ è½½å›¾åƒã€æ ·å¼è¡¨å’Œå…¶ä»–èµ„æºï¼Œæˆ–è€…ä»ç”¨æˆ·å½“å‰å·¥ä½œåŒºåŠ è½½ä»»ä½•å†…å®¹ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨"Webview.asWebviewUri"å‡½æ•°å°†æœ¬åœ°"file:"URI è½¬æ¢ä¸º VS Code å¯ç”¨äºåŠ è½½æœ¬åœ°èµ„æºå­é›†çš„ç‰¹æ®Š URIã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æƒ³è¦å¼€å§‹å°†çŒ« gif æ†ç»‘åˆ°æˆ‘ä»¬çš„æ‰©å±•ä¸­ï¼Œè€Œä¸æ˜¯ä» Giphy ä¸­æå–å®ƒä»¬ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºç£ç›˜ä¸Šæ–‡ä»¶çš„ URIï¼Œç„¶åé€šè¿‡"asWebviewUri"å‡½æ•°ä¼ é€’è¿™äº› URIï¼š

```ts
import * as vscode from 'vscode';

export function activate(context: vscode.ExtensionContext) {
    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.start', () => {
            const panel = vscode.window.createWebviewPanel('catCoding', 'Cat Coding', vscode.ViewColumn.One, {});

            // Get path to resource on disk
            const onDiskPath = vscode.Uri.joinPath(context.extensionUri, 'media', 'cat.gif');

            // And get the special URI to use with the webview
            const catGifSrc = panel.webview.asWebviewUri(onDiskPath);

            panel.webview.html = getWebviewContent(catGifSrc);
        })
    );
}
```

å¦‚æœæˆ‘ä»¬è°ƒè¯•è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°"catGifSrc"çš„å®é™…å€¼ç±»ä¼¼äºï¼š

```
vscode-resource:/Users/toonces/projects/vscode-cat-coding/media/cat.gif
```

VS Code ç†è§£è¿™ä¸ªç‰¹æ®Šçš„ URIï¼Œå¹¶å°†ä½¿ç”¨å®ƒä»ç£ç›˜åŠ è½½æˆ‘ä»¬çš„ gifï¼

é»˜è®¤æƒ…å†µä¸‹ï¼Œwebview åªèƒ½è®¿é—®ä»¥ä¸‹ä½ç½®çš„èµ„æºï¼š

-   åœ¨æ‚¨çš„æ‰©å±•çš„å®‰è£…ç›®å½•ä¸­ã€‚
-   åœ¨ç”¨æˆ·å½“å‰æ´»åŠ¨çš„å·¥ä½œç©ºé—´å†…ã€‚

ä½¿ç”¨"WebviewOptions.localResourceRoots"å…è®¸è®¿é—®å…¶ä»–æœ¬åœ°èµ„æºã€‚

æ‚¨è¿˜å¯ä»¥å§‹ç»ˆä½¿ç”¨æ•°æ® URI å°†èµ„æºç›´æ¥åµŒå…¥åˆ° Web è§†å›¾ä¸­ã€‚

### æ§åˆ¶å¯¹æœ¬åœ°èµ„æºçš„è®¿é—®

Webview å¯ä»¥ä½¿ç”¨"localResourceRoots"é€‰é¡¹æ§åˆ¶å¯ä»¥ä»ç”¨æˆ·è®¡ç®—æœºåŠ è½½å“ªäº›èµ„æºã€‚ `localResourceRoots` å®šä¹‰äº†ä¸€ç»„å¯ä»¥åŠ è½½æœ¬åœ°å†…å®¹çš„æ ¹ URIã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨"localResourceRoots"æ¥é™åˆ¶ **Cat Coding** webview ä»…ä»æ‰©å±•ä¸­çš„"media"ç›®å½•åŠ è½½èµ„æºï¼š

```ts
import * as vscode from 'vscode';

export function activate(context: vscode.ExtensionContext) {
    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.start', () => {
            const panel = vscode.window.createWebviewPanel('catCoding', 'Cat Coding', vscode.ViewColumn.One, {
                // Only allow the webview to access resources in our extension's media directory
                localResourceRoots: [vscode.Uri.joinPath(context.extensionPath, 'media')]
            });

            const onDiskPath = vscode.Uri.joinPath(context.extensionUri, 'media', 'cat.gif');
            const catGifSrc = panel.webview.asWebviewUri(onDiskPath);

            panel.webview.html = getWebviewContent(catGifSrc);
        })
    );
}
```

è¦ç¦æ­¢æ‰€æœ‰æœ¬åœ°èµ„æºï¼Œåªéœ€å°†"localResourceRoots"è®¾ç½®ä¸º"[]"ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œwebview åœ¨åŠ è½½æœ¬åœ°èµ„æºæ—¶åº”è¯¥å°½å¯èƒ½åœ°å—åˆ°é™åˆ¶ã€‚ ä½†æ˜¯ï¼Œè¯·è®°ä½"localResourceRoots"æœ¬èº«å¹¶ä¸æä¾›å®Œæ•´çš„å®‰å…¨ä¿æŠ¤ã€‚ ç¡®ä¿æ‚¨çš„ webview ä¹Ÿéµå¾ª[å®‰å…¨æœ€ä½³å®è·µ](#security)ï¼Œå¹¶æ·»åŠ [å†…å®¹å®‰å…¨ç­–ç•¥](#content-security-policy)ä»¥è¿›ä¸€æ­¥é™åˆ¶å¯ä»¥åŠ è½½çš„å†…å®¹ã€‚

### ä¸»é¢˜åŒ– webview å†…å®¹

Webview å¯ä»¥ä½¿ç”¨ CSS æ ¹æ® VS Code çš„å½“å‰ä¸»é¢˜æ›´æ”¹å…¶å¤–è§‚ã€‚ VS Code å°†ä¸»é¢˜åˆ†ä¸ºä¸‰ç±»ï¼Œå¹¶åœ¨"body"å…ƒç´ ä¸­æ·»åŠ ä¸€ä¸ªç‰¹æ®Šçš„ç±»æ¥æŒ‡ç¤ºå½“å‰ä¸»é¢˜ï¼š

-   `vscode-light` - æµ…è‰²ä¸»é¢˜ã€‚
-   `vscode-dark` - æ·±è‰²ä¸»é¢˜ã€‚
-   `vscode-high-contrast` - é«˜å¯¹æ¯”åº¦ä¸»é¢˜ã€‚

ä»¥ä¸‹ CSS æ ¹æ®ç”¨æˆ·å½“å‰çš„ä¸»é¢˜æ›´æ”¹ webview çš„æ–‡æœ¬é¢œè‰²ï¼š

```css
body.vscode-light {
    color: black;
}

body.vscode-dark {
    color: white;
}

body.vscode-high-contrast {
    color: red;
}
```

å¼€å‘ webview åº”ç”¨ç¨‹åºæ—¶ï¼Œè¯·ç¡®ä¿å®ƒé€‚ç”¨äºä¸‰ç§ç±»å‹çš„ä¸»é¢˜ã€‚ å¹¶å§‹ç»ˆåœ¨é«˜å¯¹æ¯”åº¦æ¨¡å¼ä¸‹æµ‹è¯•æ‚¨çš„ç½‘ç»œè§†å›¾ï¼Œä»¥ç¡®ä¿è§†åŠ›éšœç¢äººå£«å¯ä»¥ä½¿ç”¨å®ƒã€‚

Webview è¿˜å¯ä»¥ä½¿ç”¨ [CSS å˜é‡](https://developer.mozilla.org/docs/Web/CSS/Using_CSS_variables) è®¿é—® VS Code ä¸»é¢˜é¢œè‰²ã€‚ è¿™äº›å˜é‡åç§°ä»¥"vscode"ä¸ºå‰ç¼€ï¼Œå¹¶å°†"."æ›¿æ¢ä¸º"-"ã€‚ ä¾‹å¦‚ `editor.foreground` å˜ä¸º `var(--vscode-editor-foreground)`ï¼š

```css
code {
    color: var(--vscode-editor-foreground);
}
```

æŸ¥çœ‹[ä¸»é¢˜é¢œè‰²å‚è€ƒ](https://code.visualstudio.com/api/references/theme-color)ä»¥è·å–å¯ç”¨çš„ä¸»é¢˜å˜é‡ã€‚ [æ‰©å±•](https://marketplace.visualstudio.com/items?itemName=connor4312.css-theme-completions) å¯ç”¨ï¼Œå®ƒä¸ºå˜é‡æä¾› IntelliSense å»ºè®®ã€‚

è¿˜å®šä¹‰äº†ä»¥ä¸‹ä¸å­—ä½“ç›¸å…³çš„å˜é‡ï¼š

-   `--vscode-editor-font-family` - ç¼–è¾‘å™¨å­—ä½“ç³»åˆ—ï¼ˆæ¥è‡ª `editor.fontFamily` è®¾ç½®ï¼‰ã€‚
-   `--vscode-editor-font-weight` - ç¼–è¾‘å™¨å­—ä½“ç²—ç»†ï¼ˆæ¥è‡ª `editor.fontWeight` è®¾ç½®ï¼‰ã€‚
-   `--vscode-editor-font-size` - ç¼–è¾‘å™¨å­—ä½“å¤§å°ï¼ˆæ¥è‡ª `editor.fontSize` è®¾ç½®ï¼‰ã€‚

æœ€åï¼Œå¯¹äºéœ€è¦ç¼–å†™é’ˆå¯¹å•ä¸ªä¸»é¢˜çš„ CSS çš„ç‰¹æ®Šæƒ…å†µï¼Œwebviews çš„ body å…ƒç´ æœ‰ä¸€ä¸ªåä¸º"vscode-theme-id"çš„æ•°æ®å±æ€§ï¼Œç”¨äºå­˜å‚¨å½“å‰æ´»åŠ¨ä¸»é¢˜çš„ IDã€‚ è¿™ä½¿æ‚¨å¯ä»¥ä¸º webview ç¼–å†™ç‰¹å®šäºä¸»é¢˜çš„ CSSï¼š

```css
body[data-vscode-theme-id='One Dark Pro'] {
    background: hotpink;
}
```

### æ”¯æŒçš„åª’ä½“æ ¼å¼

Webview æ”¯æŒéŸ³é¢‘å’Œè§†é¢‘ï¼Œä½†å¹¶éæ‰€æœ‰åª’ä½“ç¼–è§£ç å™¨æˆ–åª’ä½“æ–‡ä»¶å®¹å™¨ç±»å‹éƒ½å—æ”¯æŒã€‚

Webview ä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹éŸ³é¢‘æ ¼å¼ï¼š

-   æ³¢å½¢
-   MP3
-   å¥¥æ ¼
-   å¼—æ‹‰å…‹

ç½‘ç»œè§†å›¾ä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è§†é¢‘æ ¼å¼ï¼š

-   H.264
-   VP8

å¯¹äºè§†é¢‘æ–‡ä»¶ï¼Œè¯·ç¡®ä¿è§†é¢‘å’ŒéŸ³é¢‘è½¨é“çš„åª’ä½“æ ¼å¼å‡å—æ”¯æŒã€‚ ä¾‹å¦‚ï¼Œè®¸å¤š".mp4"æ–‡ä»¶å°†"H.264"ç”¨äºè§†é¢‘å’Œ"AAC"éŸ³é¢‘ã€‚ VS Code å°†èƒ½å¤Ÿæ’­æ”¾"mp4"çš„è§†é¢‘éƒ¨åˆ†ï¼Œä½†ç”±äºä¸æ”¯æŒ"AAC"éŸ³é¢‘ï¼Œå› æ­¤ä¸ä¼šæœ‰ä»»ä½•å£°éŸ³ã€‚ ç›¸åï¼Œæ‚¨éœ€è¦ä½¿ç”¨"mp3"ä½œä¸ºéŸ³è½¨ã€‚

### ä¸Šä¸‹æ–‡èœå•

é«˜çº§ Web è§†å›¾å¯ä»¥è‡ªå®šä¹‰ç”¨æˆ·åœ¨ Web è§†å›¾å†…éƒ¨å³é”®å•å‡»æ—¶æ˜¾ç¤ºçš„ä¸Šä¸‹æ–‡èœå•ã€‚ è¿™æ˜¯ä½¿ç”¨[è´¡çŒ®ç‚¹](https://code.visualstudio.com/api/references/contribution-points.md#contribution-points)æ¥å®Œæˆçš„ï¼Œä¸ VS Code çš„æ­£å¸¸ä¸Šä¸‹æ–‡èœå•ç±»ä¼¼ï¼Œå› æ­¤è‡ªå®šä¹‰èœå•æ­£å¥½é€‚åˆ ç¼–è¾‘å™¨çš„å…¶ä½™éƒ¨åˆ†ã€‚ Web è§†å›¾è¿˜å¯ä»¥æ˜¾ç¤º Web è§†å›¾ä¸åŒéƒ¨åˆ†çš„è‡ªå®šä¹‰ä¸Šä¸‹æ–‡èœå•ã€‚

è¦å‘ Web è§†å›¾æ·»åŠ æ–°çš„ä¸Šä¸‹æ–‡èœå•é¡¹ï¼Œè¯·é¦–å…ˆåœ¨æ–°çš„"webview/context"éƒ¨åˆ†ä¸‹çš„"menus"ä¸­æ·»åŠ ä¸€ä¸ªæ–°æ¡ç›®ã€‚ æ¯ä¸ªè´¡çŒ®éƒ½éœ€è¦ä¸€ä¸ª"command"ï¼ˆè¿™ä¹Ÿæ˜¯é¡¹ç›®æ ‡é¢˜çš„æ¥æºï¼‰å’Œä¸€ä¸ª"when"å­å¥ã€‚ [when å­å¥](https://code.visualstudio.com/api/references/when-clause-contexts) åº”åŒ…å« `webviewId == 'YOUR_WEBVIEW_VIEW_TYPE'` ä»¥ç¡®ä¿ä¸Šä¸‹æ–‡èœå•ä»…é€‚ç”¨äºæ‚¨çš„æ‰©å±•ç¨‹åºçš„ webviewï¼š

```json
"contributes": {
  "menus": {
    "webview/context": [
      {
        "command": "catCoding.yarn",
        "when": "webviewId == 'catCoding'"
      },
      {
        "command": "catCoding.insertLion",
        "when": "webviewId == 'catCoding' && webviewSection == 'editor'"
      }
    ]
  },
  "commands": [
    {
      "command": "catCoding.yarn",
      "title": "Yarn ğŸ§¶",
      "category": "Cat Coding"
    },
    {
      "command": "catCoding.insertLion",
      "title": "Insert ğŸ¦",
      "category": "Cat Coding"
    },
    ...
  ]
}
```

åœ¨ Web è§†å›¾å†…éƒ¨ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨"data-vscode-context"[æ•°æ®å±æ€§](https://developer.mozilla.org/docs/Learn/HTML/Howto/Use_data_attributes) è®¾ç½® HTML ç‰¹å®šåŒºåŸŸçš„ä¸Šä¸‹æ–‡ ï¼‰ï¼ˆæˆ–è€…åœ¨ JavaScript ä¸­ä½¿ç”¨ `dataset.vscodeContext`ï¼‰ã€‚ `data-vscode-context` å€¼æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼ŒæŒ‡å®šç”¨æˆ·å³é”®å•å‡»å…ƒç´ æ—¶è¦è®¾ç½®çš„ä¸Šä¸‹æ–‡ã€‚ æœ€ç»ˆä¸Šä¸‹æ–‡æ˜¯é€šè¿‡ä»æ–‡æ¡£æ ¹åˆ°è¢«å•å‡»çš„å…ƒç´ æ¥ç¡®å®šçš„ã€‚

ä»¥è¿™ä¸ª HTML ä¸ºä¾‹ï¼š

```html
<div class="main" data-vscode-context='{"webviewSection": "main", "mouseCount": 4}'>
    <h1>Cat Coding</h1>

    <textarea data-vscode-context='{"webviewSection": "editor", "preventDefaultContextMenuItems": true}'></textarea>
</div>
```

å¦‚æœç”¨æˆ·å³é”®å•å‡»"textarea"ï¼Œå°†è®¾ç½®ä»¥ä¸‹ä¸Šä¸‹æ–‡ï¼š

-   `webviewSection == 'editor'` - è¿™ä¼šè¦†ç›–çˆ¶å…ƒç´ ä¸­çš„ `webviewSection`ã€‚
-   `mouseCount == 4` - è¿™æ˜¯ä»çˆ¶å…ƒç´ ç»§æ‰¿çš„ã€‚
-   `preventDefaultContextMenuItems == true` - è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ä¸Šä¸‹æ–‡ï¼Œéšè— VS Code é€šå¸¸æ·»åŠ åˆ° Web è§†å›¾ä¸Šä¸‹æ–‡èœå•çš„å¤åˆ¶å’Œç²˜è´´æ¡ç›®ã€‚

å¦‚æœç”¨æˆ·åœ¨"textarea"å†…éƒ¨å³é”®å•å‡»ï¼Œä»–ä»¬å°†çœ‹åˆ°ï¼š

![webview ä¸­æ˜¾ç¤ºçš„è‡ªå®šä¹‰ä¸Šä¸‹æ–‡èœå•](https://static.yicode.tech/images/vscode-docs/webview/webview-context-menus.png)

## è„šæœ¬å’Œæ¶ˆæ¯ä¼ é€’

Webview å°±åƒ iframe ä¸€æ ·ï¼Œè¿™æ„å‘³ç€å®ƒä»¬ä¹Ÿå¯ä»¥è¿è¡Œè„šæœ¬ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒJavaScript åœ¨ Web è§†å›¾ä¸­å¤„äºç¦ç”¨çŠ¶æ€ï¼Œä½†å¯ä»¥é€šè¿‡ä¼ å…¥"enableScripts: true"é€‰é¡¹è½»æ¾é‡æ–°å¯ç”¨ã€‚

è®©æˆ‘ä»¬ä½¿ç”¨è„šæœ¬æ·»åŠ ä¸€ä¸ªè®¡æ•°å™¨æ¥è·Ÿè¸ªæˆ‘ä»¬çš„çŒ«ç¼–å†™çš„æºä»£ç è¡Œã€‚ è¿è¡ŒåŸºæœ¬è„šæœ¬éå¸¸ç®€å•ï¼Œä½†è¯·æ³¨æ„ï¼Œæ­¤ç¤ºä¾‹ä»…ç”¨äºæ¼”ç¤ºç›®çš„ã€‚ å®é™…ä¸Šï¼Œæ‚¨çš„ webview åº”å§‹ç»ˆä½¿ç”¨ [å†…å®¹å®‰å…¨ç­–ç•¥](#content-security-policy) ç¦ç”¨å†…è”è„šæœ¬ï¼š

```ts
import * as path from 'path';
import * as vscode from 'vscode';

export function activate(context: vscode.ExtensionContext) {
    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.start', () => {
            const panel = vscode.window.createWebviewPanel('catCoding', 'Cat Coding', vscode.ViewColumn.One, {
                // Enable scripts in the webview
                enableScripts: true
            });

            panel.webview.html = getWebviewContent();
        })
    );
}

function getWebviewContent() {
    return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Coding</title>
</head>
<body>
    <img src="https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif" width="300" />
    <h1 id="lines-of-code-counter">0</h1>

    <script>
        const counter = document.getElementById('lines-of-code-counter');

        let count = 0;
        setInterval(() => {
            counter.textContent = count++;
        }, 100);
    </script>
</body>
</html>`;
}
```

![A script running in a webview](https://static.yicode.tech/images/vscode-docs/webview/scripts-basic.gif)

å“‡ï¼ é‚£æ˜¯ä¸€åªå¤šäº§çš„çŒ«ã€‚

Webview è„šæœ¬å‡ ä¹å¯ä»¥æ‰§è¡Œæ™®é€šç½‘é¡µä¸Šçš„è„šæœ¬å¯ä»¥æ‰§è¡Œçš„ä»»ä½•æ“ä½œã€‚ è¯·è®°ä½ï¼Œå°½ç®¡ Web è§†å›¾å­˜åœ¨äºå…¶è‡ªå·±çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå› æ­¤ Web è§†å›¾ä¸­çš„è„šæœ¬æ— æ³•è®¿é—® VS Code APIã€‚ è¿™å°±æ˜¯æ¶ˆæ¯ä¼ é€’çš„ç”¨æ­¦ä¹‹åœ°ï¼

### å°†æ¶ˆæ¯ä»æ‰©å±•ä¼ é€’åˆ° Web è§†å›¾

æ‰©å±•ç¨‹åºå¯ä»¥ä½¿ç”¨ webview.postMessage() å°†æ•°æ®å‘é€åˆ°å…¶ webviewã€‚ æ­¤æ–¹æ³•å°†ä»»ä½• JSON å¯åºåˆ—åŒ–æ•°æ®å‘é€åˆ° webviewã€‚ è¯¥æ¶ˆæ¯æ˜¯é€šè¿‡æ ‡å‡†çš„"message"äº‹ä»¶åœ¨ webview å†…æ¥æ”¶çš„ã€‚

ä¸ºäº†æ¼”ç¤ºè¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬å‘ **Cat Coding** æ·»åŠ ä¸€ä¸ªæ–°å‘½ä»¤ï¼ŒæŒ‡ç¤ºå½“å‰ç¼–ç çš„çŒ«é‡æ„å…¶ä»£ç ï¼ˆä»è€Œå‡å°‘æ€»è¡Œæ•°ï¼‰ã€‚ æ–°çš„`catCoding.doRefactor`å‘½ä»¤ä½¿ç”¨`postMessage`å°†æŒ‡ä»¤å‘é€åˆ°å½“å‰çš„ webviewï¼Œå¹¶åœ¨ webview æœ¬èº«å†…éƒ¨ä½¿ç”¨`window.addEventListener('message', event => { ... })`æ¥å¤„ç†æ¶ˆæ¯ï¼š

```ts
export function activate(context: vscode.ExtensionContext) {
    // Only allow a single Cat Coder
    let currentPanel: vscode.WebviewPanel | undefined = undefined;

    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.start', () => {
            if (currentPanel) {
                currentPanel.reveal(vscode.ViewColumn.One);
            } else {
                currentPanel = vscode.window.createWebviewPanel('catCoding', 'Cat Coding', vscode.ViewColumn.One, {
                    enableScripts: true
                });
                currentPanel.webview.html = getWebviewContent();
                currentPanel.onDidDispose(
                    () => {
                        currentPanel = undefined;
                    },
                    undefined,
                    context.subscriptions
                );
            }
        })
    );

    // Our new command
    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.doRefactor', () => {
            if (!currentPanel) {
                return;
            }

            // Send a message to our webview.
            // You can send any JSON serializable data.
            currentPanel.webview.postMessage({ command: 'refactor' });
        })
    );
}

function getWebviewContent() {
    return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Coding</title>
</head>
<body>
    <img src="https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif" width="300" />
    <h1 id="lines-of-code-counter">0</h1>

    <script>
        const counter = document.getElementById('lines-of-code-counter');

        let count = 0;
        setInterval(() => {
            counter.textContent = count++;
        }, 100);

        // Handle the message inside the webview
        window.addEventListener('message', event => {

            const message = event.data; // The JSON data our extension sent

            switch (message.command) {
                case 'refactor':
                    count = Math.ceil(count * 0.5);
                    counter.textContent = count;
                    break;
            }
        });
    </script>
</body>
</html>`;
}
```

![Passing messages to a webview](https://static.yicode.tech/images/vscode-docs/webview/scripts-extension_to_webview.gif)

### å°†æ¶ˆæ¯ä» web è§†å›¾ä¼ é€’åˆ°æ‰©å±•

Webview è¿˜å¯ä»¥å°†æ¶ˆæ¯ä¼ é€’å›å…¶æ‰©å±•ç¨‹åºã€‚ è¿™æ˜¯é€šè¿‡åœ¨ Web è§†å›¾å†…çš„ç‰¹æ®Š VS Code API å¯¹è±¡ä¸Šä½¿ç”¨"postMessage"å‡½æ•°æ¥å®Œæˆçš„ã€‚ è¦è®¿é—® VS Code API å¯¹è±¡ï¼Œè¯·åœ¨ Web è§†å›¾ä¸­è°ƒç”¨"acquireVsCodeApi"ã€‚ æ¯ä¸ªä¼šè¯åªèƒ½è°ƒç”¨è¯¥å‡½æ•°ä¸€æ¬¡ã€‚ æ‚¨å¿…é¡»ä¿ç•™æ­¤æ–¹æ³•è¿”å›çš„ VS Code API å®ä¾‹ï¼Œå¹¶å°†å…¶åˆ†å‘ç»™éœ€è¦ä½¿ç”¨å®ƒçš„ä»»ä½•å…¶ä»–å‡½æ•°ã€‚

å½“æˆ‘ä»¬çš„çŒ«åœ¨ä»£ç ä¸­å¼•å…¥é”™è¯¯æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ **Cat Coding** Web è§†å›¾ä¸­ä½¿ç”¨ VS Code API å’Œ `postMessage` æ¥å‘æ‰©å±•å‘å‡ºè­¦æŠ¥ï¼š

```js
export function activate(context: vscode.ExtensionContext) {
    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.start', () => {
            const panel = vscode.window.createWebviewPanel('catCoding', 'Cat Coding', vscode.ViewColumn.One, {
                enableScripts: true
            });

            panel.webview.html = getWebviewContent();

            // Handle messages from the webview
            panel.webview.onDidReceiveMessage(
                (message) => {
                    switch (message.command) {
                        case 'alert':
                            vscode.window.showErrorMessage(message.text);
                            return;
                    }
                },
                undefined,
                context.subscriptions
            );
        })
    );
}

function getWebviewContent() {
    return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Coding</title>
</head>
<body>
    <img src="https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif" width="300" />
    <h1 id="lines-of-code-counter">0</h1>

    <script>
        (function() {
            const vscode = acquireVsCodeApi();
            const counter = document.getElementById('lines-of-code-counter');

            let count = 0;
            setInterval(() => {
                counter.textContent = count++;

                // Alert the extension when our cat introduces a bug
                if (Math.random() < 0.001 * count) {
                    vscode.postMessage({
                        command: 'alert',
                        text: 'ğŸ›  on line ' + count
                    })
                }
            }, 100);
        }())
    </script>
</body>
</html>`;
}
```

![Passing messages from the webview to the main extension](https://static.yicode.tech/images/vscode-docs/webview/scripts-webview_to_extension.gif)

å‡ºäºå®‰å…¨åŸå› ï¼Œæ‚¨å¿…é¡»å°† VS Code API å¯¹è±¡ä¿æŒç§æœ‰å¹¶ç¡®ä¿å®ƒæ°¸è¿œä¸ä¼šæ³„æ¼åˆ°å…¨å±€èŒƒå›´å†…ã€‚

### ä½¿ç”¨ç½‘ç»œå·¥ä½œè€…

[Web Workers](https://developer.mozilla.org/docs/Web/API/Web_Workers_API/Using_web_workers) åœ¨ webview å†…éƒ¨å—æ”¯æŒï¼Œä½†æœ‰ä¸€äº›é‡è¦çš„é™åˆ¶éœ€è¦æ³¨æ„ã€‚

é¦–å…ˆï¼Œworker åªèƒ½ä½¿ç”¨"data:"æˆ–"blob:" URI åŠ è½½ã€‚ æ‚¨æ— æ³•ç›´æ¥ä»æ‰©å±•çš„æ–‡ä»¶å¤¹åŠ è½½å·¥ä½œäººå‘˜ã€‚

å¦‚æœæ‚¨ç¡®å®éœ€è¦ä»æ‰©å±•ä¸­çš„ JavaScript æ–‡ä»¶åŠ è½½å·¥ä½œä»£ç ï¼Œè¯·å°è¯•ä½¿ç”¨"fetch"ï¼š

```js
const workerSource = 'absolute/path/to/worker.js';

fetch(workerSource)
    .then((result) => result.blob())
    .then((blob) => {
        const blobUrl = URL.createObjectURL(blob);
        new Worker(blobUrl);
    });
```

Worker è„šæœ¬ä¹Ÿä¸æ”¯æŒä½¿ç”¨"importScripts"æˆ–"import(...)"å¯¼å…¥æºä»£ç ã€‚ å¦‚æœæ‚¨çš„å·¥ä½œå™¨åŠ¨æ€åŠ è½½ä»£ç ï¼Œè¯·å°è¯•ä½¿ç”¨è¯¸å¦‚ [webpack](https://webpack.js.org) ä¹‹ç±»çš„æ†ç»‘å™¨å°†å·¥ä½œå™¨è„šæœ¬æ‰“åŒ…åˆ°å•ä¸ªæ–‡ä»¶ä¸­ã€‚

é€šè¿‡"webpack"ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨"LimitChunkCountPlugin"å¼ºåˆ¶ç¼–è¯‘åçš„å·¥ä½œ JavaScript æˆä¸ºå•ä¸ªæ–‡ä»¶ï¼š

```js
const path = require('path');
const webpack = require('webpack');

module.exports = {
    target: 'webworker',
    entry: './worker/src/index.js',
    output: {
        filename: 'worker.js',
        path: path.resolve(__dirname, 'media')
    },
    plugins: [
        new webpack.optimize.LimitChunkCountPlugin({
            maxChunks: 1
        })
    ]
};
```

## å®‰å…¨

ä¸ä»»ä½•ç½‘é¡µä¸€æ ·ï¼Œåˆ›å»º Web è§†å›¾æ—¶ï¼Œæ‚¨å¿…é¡»éµå¾ªä¸€äº›åŸºæœ¬çš„å®‰å…¨æœ€ä½³å®è·µã€‚

### é™åˆ¶èƒ½åŠ›

Webview åº”è¯¥å…·æœ‰å®ƒæ‰€éœ€çš„æœ€å°åŠŸèƒ½é›†ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„ webview ä¸éœ€è¦è¿è¡Œè„šæœ¬ï¼Œåˆ™ä¸è¦è®¾ç½® `enableScripts: true`ã€‚ å¦‚æœæ‚¨çš„ webview ä¸éœ€è¦ä»ç”¨æˆ·å·¥ä½œåŒºåŠ è½½èµ„æºï¼Œè¯·å°† `localResourceRoots` è®¾ç½®ä¸º `[vscode.Uri.file(extensionContext.extensionPath)]` ç”šè‡³ `[]` ä»¥ç¦æ­¢è®¿é—®æ‰€æœ‰æœ¬åœ°èµ„æºã€‚

### å†…å®¹å®‰å…¨æ”¿ç­–

[å†…å®¹å®‰å…¨ç­–ç•¥](https://developers.google.com/web/fundamentals/security/csp/)è¿›ä¸€æ­¥é™åˆ¶å¯ä»¥åœ¨ç½‘ç»œè§†å›¾ä¸­åŠ è½½å’Œæ‰§è¡Œçš„å†…å®¹ã€‚ ä¾‹å¦‚ï¼Œå†…å®¹å®‰å…¨ç­–ç•¥å¯ä»¥ç¡®ä¿åªæœ‰å…è®¸çš„è„šæœ¬åˆ—è¡¨å¯ä»¥åœ¨ Web è§†å›¾ä¸­è¿è¡Œï¼Œç”šè‡³å‘Šè¯‰ Web è§†å›¾ä»…é€šè¿‡"https"åŠ è½½å›¾åƒã€‚

è¦æ·»åŠ å†…å®¹å®‰å…¨ç­–ç•¥ï¼Œè¯·å°† `<meta http-equiv="Content-Security-Policy">` æŒ‡ä»¤æ”¾åœ¨ webview çš„ `<head>` é¡¶éƒ¨

```ts
function getWebviewContent() {
    return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <meta http-equiv="Content-Security-Policy" content="default-src 'none';">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Cat Coding</title>
</head>
<body>
    ...
</body>
</html>`;
}
```

ç­–ç•¥"default-src 'none';"ç¦æ­¢æ‰€æœ‰å†…å®¹ã€‚ ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°å¯ç”¨æ‰©å±•ç¨‹åºè¿è¡Œæ‰€éœ€çš„æœ€å°‘é‡å†…å®¹ã€‚ è¿™æ˜¯ä¸€ä¸ªå†…å®¹å®‰å…¨ç­–ç•¥ï¼Œå…è®¸åŠ è½½æœ¬åœ°è„šæœ¬å’Œæ ·å¼è¡¨ï¼Œä»¥åŠé€šè¿‡"https"åŠ è½½å›¾åƒï¼š

```html
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src ${webview.cspSource} https:; script-src ${webview.cspSource}; style-src ${webview.cspSource};" />
```

`${webview.cspSource}` å€¼æ˜¯æ¥è‡ª webview å¯¹è±¡æœ¬èº«çš„å€¼çš„å ä½ç¬¦ã€‚ æœ‰å…³å¦‚ä½•ä½¿ç”¨æ­¤å€¼çš„å®Œæ•´ç¤ºä¾‹ï¼Œè¯·å‚é˜… [webview ç¤ºä¾‹](https://github.com/microsoft/vscode-extension-samples/blob/main/webview-sample)ã€‚

æ­¤å†…å®¹å®‰å…¨ç­–ç•¥è¿˜éšå¼ç¦ç”¨å†…è”è„šæœ¬å’Œæ ·å¼ã€‚ æœ€ä½³å®è·µæ˜¯å°†æ‰€æœ‰å†…è”æ ·å¼å’Œè„šæœ¬æå–åˆ°å¤–éƒ¨æ–‡ä»¶ï¼Œä»¥ä¾¿å¯ä»¥åœ¨ä¸æ”¾æ¾å†…å®¹å®‰å…¨ç­–ç•¥çš„æƒ…å†µä¸‹æ­£ç¡®åŠ è½½å®ƒä»¬ã€‚

### ä»…é€šè¿‡ https åŠ è½½å†…å®¹

å¦‚æœæ‚¨çš„ webview å…è®¸åŠ è½½å¤–éƒ¨èµ„æºï¼Œå¼ºçƒˆå»ºè®®æ‚¨åªå…è®¸é€šè¿‡ `https` è€Œä¸æ˜¯é€šè¿‡ http åŠ è½½è¿™äº›èµ„æºã€‚ ä¸Šé¢çš„ç¤ºä¾‹å†…å®¹å®‰å…¨ç­–ç•¥å·²ç»é€šè¿‡ä»…å…è®¸é€šè¿‡"https:"åŠ è½½å›¾åƒæ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚

### æ¸…ç†æ‰€æœ‰ç”¨æˆ·è¾“å…¥

å°±åƒå¤„ç†æ™®é€šç½‘é¡µä¸€æ ·ï¼Œåœ¨ä¸º webview æ„å»º HTML æ—¶ï¼Œå¿…é¡»æ¸…ç†æ‰€æœ‰ç”¨æˆ·è¾“å…¥ã€‚ æœªèƒ½æ­£ç¡®æ¸…ç†è¾“å…¥å¯èƒ½ä¼šå…è®¸å†…å®¹æ³¨å…¥ï¼Œè¿™å¯èƒ½ä¼šè®©æ‚¨çš„ç”¨æˆ·é¢ä¸´å®‰å…¨é£é™©ã€‚

å¿…é¡»æ¸…ç†çš„ç¤ºä¾‹å€¼ï¼š

-   æ–‡ä»¶å†…å®¹ã€‚
-   æ–‡ä»¶å’Œæ–‡ä»¶å¤¹è·¯å¾„ã€‚
-   ç”¨æˆ·å’Œå·¥ä½œåŒºè®¾ç½®ã€‚

è€ƒè™‘ä½¿ç”¨å¸®åŠ©ç¨‹åºåº“æ¥æ„å»º HTML å­—ç¬¦ä¸²ï¼Œæˆ–è€…è‡³å°‘ç¡®ä¿ç”¨æˆ·å·¥ä½œåŒºä¸­çš„æ‰€æœ‰å†…å®¹éƒ½ç»è¿‡æ­£ç¡®æ¸…ç†ã€‚

åˆ‡å‹¿ä»…ä¾é æ¶ˆæ¯’æ¥ç¡®ä¿å®‰å…¨ã€‚ ç¡®ä¿éµå¾ªå…¶ä»–å®‰å…¨æœ€ä½³å®è·µï¼Œä¾‹å¦‚åˆ¶å®š[å†…å®¹å®‰å…¨ç­–ç•¥](#content-security-policy)ï¼Œä»¥å°½é‡å‡å°‘ä»»ä½•æ½œåœ¨å†…å®¹æ³¨å…¥çš„å½±å“ã€‚

## åšæŒ

åœ¨æ ‡å‡† webview [lifecycle](#lifecycle) ä¸­ï¼Œwebview ç”± `createWebviewPanel` åˆ›å»ºï¼Œå¹¶åœ¨ç”¨æˆ·å…³é—­å®ƒä»¬æˆ–è°ƒç”¨ `.dispose()` æ—¶é”€æ¯ã€‚ ç„¶è€Œï¼Œwebview çš„å†…å®¹æ˜¯åœ¨ webview å˜å¾—å¯è§æ—¶åˆ›å»ºçš„ï¼Œå¹¶åœ¨ webview ç§»å…¥åå°æ—¶é”€æ¯çš„ã€‚ å½“ Web è§†å›¾ç§»åŠ¨åˆ°åå°é€‰é¡¹å¡æ—¶ï¼ŒWeb è§†å›¾å†…çš„ä»»ä½•çŠ¶æ€éƒ½å°†ä¸¢å¤±ã€‚

è§£å†³è¿™ä¸ªé—®é¢˜çš„æœ€å¥½æ–¹æ³•æ˜¯è®©ä½ çš„ webview æ— çŠ¶æ€ã€‚ ä½¿ç”¨æ¶ˆæ¯ä¼ é€’æ¥ä¿å­˜ webview çš„çŠ¶æ€ï¼Œç„¶ååœ¨ webview å†æ¬¡å¯è§æ—¶æ¢å¤çŠ¶æ€ã€‚

### getState å’Œ setState

åœ¨ webview ä¸­è¿è¡Œçš„è„šæœ¬å¯ä»¥ä½¿ç”¨ `getState` å’Œ `setState` æ–¹æ³•æ¥ä¿å­˜å’Œæ¢å¤ JSON å¯åºåˆ—åŒ–çŠ¶æ€å¯¹è±¡ã€‚ å½“ Web è§†å›¾é¢æ¿éšè—æ—¶ï¼Œå³ä½¿ Web è§†å›¾å†…å®¹æœ¬èº«è¢«ç ´åï¼Œæ­¤çŠ¶æ€ä¹Ÿä¼šæŒç»­å­˜åœ¨ã€‚ å½“ webview é¢æ¿è¢«é”€æ¯æ—¶ï¼ŒçŠ¶æ€ä¹Ÿè¢«é”€æ¯ã€‚

```js
// Inside a webview script
const vscode = acquireVsCodeApi();

const counter = document.getElementById('lines-of-code-counter');

// Check if we have an old state to restore from
const previousState = vscode.getState();
let count = previousState ? previousState.count : 0;
counter.textContent = count;

setInterval(() => {
    counter.textContent = count++;
    // Update the saved state
    vscode.setState({ count });
}, 100);
```

`getState` å’Œ `setState` æ˜¯æŒä¹…çŠ¶æ€çš„é¦–é€‰æ–¹å¼ï¼Œå› ä¸ºå®ƒä»¬çš„æ€§èƒ½å¼€é”€æ¯” `retainContextWhenHidden` ä½å¾—å¤šã€‚

### åºåˆ—åŒ–

é€šè¿‡å®ç°"WebviewPanelSerializer"ï¼Œæ‚¨çš„ webview å¯ä»¥åœ¨ VS Code é‡æ–°å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤ã€‚ åºåˆ—åŒ–å»ºç«‹åœ¨"getState"å’Œ"setState"ä¹‹ä¸Šï¼Œå¹¶ä¸”ä»…å½“æ‚¨çš„æ‰©å±•ç¨‹åºä¸ºæ‚¨çš„ webview æ³¨å†Œäº†"WebviewPanelSerializer"æ—¶æ‰å¯ç”¨ã€‚

ä¸ºäº†è®©æˆ‘ä»¬çš„ç¼–ç çŒ«åœ¨ VS Code é‡å¯åæŒç»­å­˜åœ¨ï¼Œé¦–å…ˆå°†ä¸€ä¸ª `onWebviewPanel` æ¿€æ´»äº‹ä»¶æ·»åŠ åˆ°æ‰©å±•çš„ `package.json` ä¸­ï¼š

```json
"activationEvents": [
    ...,
    "onWebviewPanel:catCoding"
]
```

æ­¤æ¿€æ´»äº‹ä»¶ç¡®ä¿æ¯å½“ VS Code éœ€è¦æ¢å¤å…·æœ‰ viewTypeï¼š"catCoding"çš„ Web è§†å›¾æ—¶ï¼Œæˆ‘ä»¬çš„æ‰©å±•éƒ½ä¼šè¢«æ¿€æ´»ã€‚

ç„¶åï¼Œåœ¨æˆ‘ä»¬çš„æ‰©å±•çš„"activate"æ–¹æ³•ä¸­ï¼Œè°ƒç”¨"registerWebviewPanelSerializer"æ¥æ³¨å†Œä¸€ä¸ªæ–°çš„"WebviewPanelSerializer"ã€‚ `WebviewPanelSerializer` è´Ÿè´£ä»æŒä¹…çŠ¶æ€æ¢å¤ webview çš„å†…å®¹ã€‚ è¯¥çŠ¶æ€æ˜¯ webview å†…å®¹ä½¿ç”¨ setState è®¾ç½®çš„ JSON blobã€‚

```ts
export function activate(context: vscode.ExtensionContext) {
    // Normal setup...

    // And make sure we register a serializer for our webview type
    vscode.window.registerWebviewPanelSerializer('catCoding', new CatCodingSerializer());
}

class CatCodingSerializer implements vscode.WebviewPanelSerializer {
    async deserializeWebviewPanel(webviewPanel: vscode.WebviewPanel, state: any) {
        // `state` is the state persisted using `setState` inside the webview
        console.log(`Got state: ${state}`);

        // Restore the content of our webview.
        //
        // Make sure we hold on to the `webviewPanel` passed in here and
        // also restore any event listeners we need on it.
        webviewPanel.webview.html = getWebviewContent();
    }
}
```

ç°åœ¨ï¼Œå¦‚æœæ‚¨åœ¨æ‰“å¼€ cat ç¼–ç é¢æ¿çš„æƒ…å†µä¸‹é‡æ–°å¯åŠ¨ VS Codeï¼Œè¯¥é¢æ¿å°†è‡ªåŠ¨æ¢å¤åˆ°ç›¸åŒçš„ç¼–è¾‘å™¨ä½ç½®ã€‚

### keepContextWhenHidden

å¯¹äºå…·æœ‰éå¸¸å¤æ‚çš„ UI æˆ–çŠ¶æ€ä¸”æ— æ³•å¿«é€Ÿä¿å­˜å’Œæ¢å¤çš„ WebViewï¼Œæ‚¨å¯ä»¥ä½¿ç”¨"retainContextWhenHidden"é€‰é¡¹ã€‚ æ­¤é€‰é¡¹ä½¿ Web è§†å›¾ä¿ç•™å…¶å†…å®¹ï¼Œä½†å¤„äºéšè—çŠ¶æ€ï¼Œå³ä½¿ Web è§†å›¾æœ¬èº«ä¸å†ä½äºå‰å°ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

è™½ç„¶ **Cat Coding** å¾ˆéš¾è¯´æœ‰å¤æ‚çš„çŠ¶æ€ï¼Œä½†è®©æˆ‘ä»¬å°è¯•å¯ç”¨ `retainContextWhenHidden` æ¥çœ‹çœ‹è¯¥é€‰é¡¹å¦‚ä½•æ”¹å˜ webview çš„è¡Œä¸ºï¼š

```ts
import * as vscode from 'vscode';

export function activate(context: vscode.ExtensionContext) {
    context.subscriptions.push(
        vscode.commands.registerCommand('catCoding.start', () => {
            const panel = vscode.window.createWebviewPanel('catCoding', 'Cat Coding', vscode.ViewColumn.One, {
                enableScripts: true,
                retainContextWhenHidden: true
            });
            panel.webview.html = getWebviewContent();
        })
    );
}

function getWebviewContent() {
    return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Coding</title>
</head>
<body>
    <img src="https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif" width="300" />
    <h1 id="lines-of-code-counter">0</h1>

    <script>
        const counter = document.getElementById('lines-of-code-counter');

        let count = 0;
        setInterval(() => {
            counter.textContent = count++;
        }, 100);
    </script>
</body>
</html>`;
}
```

![persistence retrain](https://static.yicode.tech/images/vscode-docs/webview/persistence-retrain.gif)

è¯·æ³¨æ„ï¼Œå½“ Web è§†å›¾éšè—ç„¶åæ¢å¤æ—¶ï¼Œè®¡æ•°å™¨ç°åœ¨ä¸ä¼šé‡ç½®ã€‚ æ— éœ€é¢å¤–ä»£ç ï¼ ä½¿ç”¨"retainContextWhenHidden"ï¼Œç½‘ç»œè§†å›¾çš„è¡Œä¸ºç±»ä¼¼äºç½‘ç»œæµè§ˆå™¨ä¸­çš„åå°é€‰é¡¹å¡ã€‚ è„šæœ¬å’Œå…¶ä»–åŠ¨æ€å†…å®¹è¢«æš‚åœï¼Œä½†ä¸€æ—¦ Web è§†å›¾å†æ¬¡å¯è§ï¼Œå°±ä¼šç«‹å³æ¢å¤ã€‚ å³ä½¿å¯ç”¨äº†"retainContextWhenHidden"ï¼Œæ‚¨ä¹Ÿæ— æ³•å°†æ¶ˆæ¯å‘é€åˆ°éšè—çš„ webviewã€‚

å°½ç®¡"retainContextWhenHidden"å¯èƒ½å¾ˆæœ‰å¸å¼•åŠ›ï¼Œä½†è¯·è®°ä½ï¼Œè¿™å…·æœ‰å¾ˆé«˜çš„å†…å­˜å¼€é”€ï¼Œå¹¶ä¸”ä»…åº”åœ¨å…¶ä»–æŒä¹…æ€§æŠ€æœ¯ä¸èµ·ä½œç”¨æ—¶ä½¿ç”¨ã€‚

## è¾…åŠ©åŠŸèƒ½

åœ¨ç”¨æˆ·ä½¿ç”¨å±å¹•é˜…è¯»å™¨æ“ä½œ VS Code çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œç±» `vscode-using-screen-reader` å°†è¢«æ·»åŠ åˆ° webview çš„ä¸»ä½“ä¸­ã€‚ æ­¤å¤–ï¼Œå¦‚æœç”¨æˆ·è¡¨è¾¾äº†å‡å°‘çª—å£ä¸­è¿åŠ¨é‡çš„åå¥½ï¼Œåˆ™ç±»"vscode-reduce-motion"å°†è¢«æ·»åŠ åˆ°æ–‡æ¡£çš„ä¸»ä½“å…ƒç´ ä¸­ã€‚ é€šè¿‡è§‚å¯Ÿè¿™äº›ç±»å¹¶ç›¸åº”åœ°è°ƒæ•´ä½ çš„æ¸²æŸ“ï¼Œä½ çš„ webview å†…å®¹å¯ä»¥æ›´å¥½åœ°åæ˜ ç”¨æˆ·çš„åå¥½ã€‚

## ä¸‹ä¸€æ­¥

å¦‚æœæ‚¨æƒ³äº†è§£æœ‰å…³ VS Code æ‰©å±•æ€§çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å°è¯•ä»¥ä¸‹ä¸»é¢˜ï¼š

-   [æ‰©å±• API](https://code.visualstudio.com/api/) - äº†è§£å®Œæ•´çš„ VS Code æ‰©å±• APIã€‚
-   [æ‰©å±•åŠŸèƒ½](https://code.visualstudio.com/api/extension-capability/overview) - æŸ¥çœ‹æ‰©å±• VS Code çš„å…¶ä»–æ–¹æ³•ã€‚
